<!doctype html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>Admin Panel - BeardedVibes</title>
	<link rel="stylesheet" href="/style.css" />
	<style>
		body {
			background: linear-gradient(180deg, var(--yt-bg) 0%, #0a0a0a 100%);
			min-height: 100vh;
		}

		.admin-container {
			max-width: 1200px;
			margin: 0 auto;
			padding: 24px;
		}

		.admin-content {
			background: linear-gradient(180deg, rgba(24, 24, 24, 0.9) 0%, rgba(18, 18, 18, 0.95) 100%);
			border: 1px solid rgba(255, 255, 255, 0.08);
			border-radius: var(--radius-xl);
			padding: 28px;
			box-shadow: 0 24px 64px rgba(0, 0, 0, 0.4);
		}

		.admin-tabs {
			display: flex;
			gap: 12px;
			margin-bottom: 28px;
			padding-bottom: 20px;
			border-bottom: 1px solid rgba(255, 255, 255, 0.08);
		}

		.tab-btn {
			padding: 12px 24px;
			background: rgba(255, 255, 255, 0.05);
			border: 1px solid rgba(255, 255, 255, 0.1);
			border-radius: var(--radius-md);
			color: var(--yt-text);
			cursor: pointer;
			font-weight: 600;
			font-size: 14px;
			transition: all var(--transition-fast);
		}

		.tab-btn:hover {
			background: rgba(255, 255, 255, 0.08);
			border-color: rgba(255, 255, 255, 0.15);
			transform: translateY(-2px);
		}

		.tab-btn.active {
			background: var(--yt-gradient);
			border-color: transparent;
			color: white;
			box-shadow: 0 8px 24px rgba(255, 106, 0, 0.3);
		}

		.tab-content {
			display: none;
		}

		.tab-content.active {
			display: block;
			animation: fadeIn 0.3s ease;
		}

		@keyframes fadeIn {
			from { opacity: 0; transform: translateY(10px); }
			to { opacity: 1; transform: translateY(0); }
		}

		.admin-list {
			display: flex;
			flex-direction: column;
			gap: 12px;
		}

		.admin-item {
			display: flex;
			align-items: center;
			gap: 16px;
			padding: 18px 20px;
			background: rgba(255, 255, 255, 0.03);
			border: 1px solid rgba(255, 255, 255, 0.06);
			border-radius: var(--radius-md);
			transition: all var(--transition-fast);
		}

		.admin-item:hover {
			background: rgba(255, 255, 255, 0.06);
			border-color: rgba(255, 255, 255, 0.1);
			transform: translateX(4px);
		}

		.admin-item-info {
			flex: 1;
		}

		.admin-item-title {
			font-weight: 600;
			color: var(--yt-text);
			margin-bottom: 6px;
			font-size: 15px;
		}

		.admin-item-meta {
			font-size: 13px;
			color: var(--yt-text-secondary);
		}

		.admin-item-actions {
			display: flex;
			gap: 8px;
			flex-wrap: wrap;
		}

		.admin-btn {
			padding: 8px 14px;
			border: none;
			border-radius: 18px;
			cursor: pointer;
			font-size: 13px;
			font-weight: 500;
			transition: all 0.2s ease;
		}

		.admin-btn.danger {
			background: rgba(255, 68, 68, 0.15);
			color: #ff6b6b;
		}

		.admin-btn.danger:hover {
			background: #ff4444;
			color: white;
		}

		.admin-btn.warning {
			background: rgba(255, 152, 0, 0.15);
			color: #ffb74d;
		}

		.admin-btn.warning:hover {
			background: #ff9800;
			color: white;
		}

		.admin-btn.success {
			background: rgba(76, 175, 80, 0.15);
			color: #81c784;
		}

		.admin-btn.success:hover {
			background: #4caf50;
			color: white;
		}

		.admin-btn:disabled {
			opacity: 0.5;
			cursor: not-allowed;
		}

		.admin-header {
			margin-bottom: 24px;
		}

		.admin-header h2 {
			color: var(--yt-text);
			margin: 0 0 8px 0;
			font-size: 22px;
			font-weight: 700;
		}

		.loading {
			text-align: center;
			padding: 40px;
			color: var(--yt-text-secondary);
			font-size: 15px;
		}

		.error-msg {
			background: rgba(255, 68, 68, 0.15);
			border: 1px solid rgba(255, 68, 68, 0.3);
			color: #ff6b6b;
			padding: 14px 18px;
			border-radius: var(--radius-md);
			margin-bottom: 16px;
			font-weight: 500;
		}

		.success-msg {
			background: rgba(76, 175, 80, 0.15);
			border: 1px solid rgba(76, 175, 80, 0.3);
			color: #81c784;
			padding: 14px 18px;
			border-radius: var(--radius-md);
			margin-bottom: 16px;
			font-weight: 500;
		}

		.top-bar {
			display: flex;
			align-items: center;
			justify-content: space-between;
			padding: 18px 24px;
			background: linear-gradient(180deg, rgba(20, 20, 20, 0.98) 0%, rgba(15, 15, 15, 0.95) 100%);
			border-bottom: 1px solid rgba(255, 255, 255, 0.08);
			backdrop-filter: blur(12px);
			position: sticky;
			top: 0;
			z-index: 100;
		}

		.top-bar h1 {
			margin: 0;
			font-size: 24px;
			font-weight: 700;
			background: var(--yt-gradient);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			background-clip: text;
		}

		.back-link {
			color: var(--yt-accent);
			text-decoration: none;
			font-weight: 600;
			padding: 10px 18px;
			border-radius: var(--radius-md);
			background: rgba(62, 166, 255, 0.1);
			border: 1px solid rgba(62, 166, 255, 0.2);
			transition: all var(--transition-fast);
		}

		.back-link:hover {
			background: rgba(62, 166, 255, 0.15);
			transform: translateY(-2px);
			box-shadow: 0 4px 16px rgba(62, 166, 255, 0.2);
		}

		/* Mobile Responsive Styles */
		@media (max-width: 768px) {
			.admin-container {
				padding: 16px;
			}
			
			.admin-content {
				padding: 16px;
				border-radius: 16px;
			}
			
			.admin-tabs {
				flex-wrap: wrap;
				gap: 8px;
			}
			
			.tab-btn {
				padding: 10px 16px;
				font-size: 13px;
				flex: 1;
				min-width: 120px;
				text-align: center;
			}
			
			.admin-item {
				flex-direction: column;
				align-items: flex-start;
				gap: 12px;
				padding: 14px;
			}
			
			.admin-item img {
				width: 100%;
				max-width: 200px;
			}
			
			.admin-item-actions {
				width: 100%;
				display: flex;
				gap: 8px;
				flex-wrap: wrap;
			}
			
			.admin-item-actions button {
				flex: 1;
				min-width: 100px;
			}
			
			.top-bar {
				padding: 14px 16px;
			}
			
			.top-bar h1 {
				font-size: 18px;
			}
			
			.back-link {
				padding: 8px 12px;
				font-size: 13px;
			}
		}
		
		@media (max-width: 480px) {
			.admin-container {
				padding: 10px;
			}
			
			.admin-content {
				padding: 12px;
			}
			
			.admin-tabs {
				flex-direction: column;
			}
			
			.tab-btn {
				width: 100%;
			}
			
			.top-bar h1 {
				font-size: 16px;
			}
		}
	</style>
</head>
<body>
	<div class="top-bar">
		<h1>‚öôÔ∏è Admin Panel</h1>
		<a href="/" class="back-link">‚Üê Back to Home</a>
	</div>

	<div class="admin-container">
		<div class="admin-content">
			<div class="admin-tabs">
				<button class="tab-btn active" data-tab="posts">Posts</button>
				<button class="tab-btn" data-tab="users">Users</button>
			</div>

			<div id="posts" class="tab-content active">
				<div class="admin-header">
					<h2>Manage Posts</h2>
					<p style="color: var(--yt-text-secondary); margin: 0">Delete or moderate user videos</p>
				</div>
				<div id="posts-list" class="admin-list">
					<div class="loading">Loading posts...</div>
				</div>
			</div>

			<div id="users" class="tab-content">
				<div class="admin-header">
					<h2>Manage Users</h2>
					<p style="color: var(--yt-text-secondary); margin: 0">Ban, verify, promote admins, or manage user accounts</p>
				</div>
				<div id="users-list" class="admin-list">
					<div class="loading">Loading users...</div>
				</div>
			</div>
		</div>
	</div>

	<script>
		let state = {
			user: null,
			posts: [],
			users: []
		};

		// Tab switching
		document.querySelectorAll('.tab-btn').forEach(btn => {
			btn.addEventListener('click', () => {
				document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
				document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
				btn.classList.add('active');
				document.getElementById(btn.dataset.tab).classList.add('active');
			});
		});

		// Check auth
		async function checkAuth() {
			const res = await fetch('/api/auth/me');
			const data = await res.json();
			state.user = data.user;

			if (!state.user || !state.user.isAdmin) {
				document.body.innerHTML = '<div style="padding: 20px; color: red; text-align: center;"><h2>Access Denied</h2><p>You must be an admin to access this page.</p><a href="/">Back to Home</a></div>';
				return false;
			}
			return true;
		}

		// Load posts
		async function loadPosts() {
			try {
				const res = await fetch('/api/posts');
				const data = await res.json();
				state.posts = data.posts || [];
				renderPosts();
			} catch (err) {
				console.error('Error loading posts:', err);
				document.getElementById('posts-list').innerHTML = '<div class="error-msg">Failed to load posts</div>';
			}
		}

		// Render posts
		function renderPosts() {
			const container = document.getElementById('posts-list');
			if (!state.posts.length) {
				container.innerHTML = '<div style="color: var(--yt-text-secondary);">No posts found</div>';
				return;
			}

			container.innerHTML = state.posts.map(post => `
				<div class="admin-item">
					<div class="admin-item-info">
						<div class="admin-item-title">${escapeHtml(post.title || 'Untitled')}</div>
						<div class="admin-item-meta">
							By ${escapeHtml(post.uploaderName || 'Unknown')} ‚Ä¢ 
							${new Date(post.createdAt).toLocaleDateString()} ‚Ä¢
							${post.likes || 0} likes
						</div>
					</div>
					<div class="admin-item-actions">
						<button class="admin-btn danger" onclick="deletePost(${post.id})">Delete</button>
					</div>
				</div>
			`).join('');
		}

		// Delete post
		async function deletePost(postId) {
			if (!confirm('Are you sure you want to delete this post?')) return;

			try {
				const res = await fetch(`/api/post/${postId}`, { method: 'DELETE' });
				const data = await res.json();

				if (res.ok) {
					state.posts = state.posts.filter(p => p.id !== postId);
					renderPosts();
					showSuccess('Post deleted successfully');
				} else {
					showError(data.error || 'Failed to delete post');
				}
			} catch (err) {
				showError('Error deleting post: ' + err.message);
			}
		}

		// Load users
		async function loadUsers() {
			try {
				const res = await fetch('/api/admin/users');
				const data = await res.json();
				state.users = data.users || [];
				renderUsers();
			} catch (err) {
				console.error('Error loading users:', err);
				document.getElementById('users-list').innerHTML = '<div class="error-msg">Failed to load users</div>';
			}
		}

		// Render users
		function renderUsers() {
			const container = document.getElementById('users-list');
			if (!state.users.length) {
				container.innerHTML = '<div style="color: var(--yt-text-secondary);">No users found</div>';
				return;
			}

			container.innerHTML = state.users.map(user => `
				<div class="admin-item">
					<div class="admin-item-info">
						<div class="admin-item-title">${escapeHtml(user.username)}</div>
						<div class="admin-item-meta">
							ID: ${user.discordId} ‚Ä¢
							${user.isBanned ? 'üö´ Banned' : '‚úì Active'} ‚Ä¢
							${user.isVerified ? '‚úì Verified' : 'Unverified'}
						</div>
					</div>
					<div class="admin-item-actions">
						<button class="admin-btn warning" onclick="warnUser('${user.discordId}', '${escapeHtml(user.username)}')">‚ö†Ô∏è Warn</button>
						${user.isBanned 
							? `<button class="admin-btn success" onclick="toggleBan('${user.discordId}', false)">Unban</button>`
							: `<button class="admin-btn danger" onclick="toggleBan('${user.discordId}', true)">Ban</button>`
						}
						${user.isVerified
							? `<button class="admin-btn warning" onclick="toggleVerify('${user.discordId}', false)">Unverify</button>`
							: `<button class="admin-btn success" onclick="toggleVerify('${user.discordId}', true)">Verify</button>`
						}
						${user.isAdmin
							? `<button class="admin-btn warning" onclick="toggleAdmin('${user.discordId}', false)">Remove Admin</button>`
							: `<button class="admin-btn" style="background: #9c27b0; color: white;" onclick="toggleAdmin('${user.discordId}', true)">Make Admin</button>`
						}
					</div>
				</div>
			`).join('');
		}

		// Warn user
		async function warnUser(discordId, username) {
			const message = prompt(`Send a warning to ${username}:\n\nEnter your warning message (e.g., "Your video was removed for violating community guidelines"):`);
			
			if (!message || !message.trim()) {
				return; // User cancelled or empty message
			}

			try {
				const res = await fetch(`/api/admin/user/${discordId}/warn`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ message: message.trim() })
				});
				const data = await res.json();

				if (res.ok) {
					showSuccess(`Warning sent to ${username}`);
				} else {
					showError(data.error || 'Failed to send warning');
				}
			} catch (err) {
				showError('Error: ' + err.message);
			}
		}

		// Ban/Unban user
		async function toggleBan(discordId, banned) {
			const action = banned ? 'ban' : 'unban';
			if (!confirm(`Are you sure you want to ${action} this user?`)) return;

			try {
				const res = await fetch(`/api/admin/user/${discordId}/ban`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ banned })
				});
				const data = await res.json();

				if (res.ok) {
					const user = state.users.find(u => u.discordId === discordId);
					if (user) user.isBanned = banned;
					renderUsers();
					showSuccess(data.message);
				} else {
					showError(data.error || 'Failed to update user');
				}
			} catch (err) {
				showError('Error: ' + err.message);
			}
		}

		// Verify/Unverify user
		async function toggleVerify(discordId, verified) {
			const action = verified ? 'verify' : 'unverify';
			if (!confirm(`Are you sure you want to ${action} this user?`)) return;

			try {
				const res = await fetch(`/api/admin/user/${discordId}/verify`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ verified })
				});
				const data = await res.json();

				if (res.ok) {
					const user = state.users.find(u => u.discordId === discordId);
					if (user) user.isVerified = verified;
					renderUsers();
					showSuccess(data.message);
				} else {
					showError(data.error || 'Failed to update user');
				}
			} catch (err) {
				showError('Error: ' + err.message);
			}
		}

		// Make/Remove Admin
		async function toggleAdmin(discordId, makeAdmin) {
			const action = makeAdmin ? 'promote to admin' : 'remove admin privileges from';
			
			// Multiple warnings for making someone admin
			if (makeAdmin) {
				if (!confirm(`‚ö†Ô∏è WARNING: You are about to make this user an ADMIN.\n\nAdmins can:\n- Ban/unban users\n- Verify users\n- Promote other admins\n- Delete content\n\nAre you sure?`)) return;
				
				if (!confirm(`‚ö†Ô∏è FINAL WARNING!\n\nThis will give FULL ADMIN POWERS to this user.\nThey will have the same permissions as you.\n\nType "YES" in the next prompt to confirm.`)) return;
				
				const confirmation = prompt('Type "YES" in CAPITAL LETTERS to confirm:');
				if (confirmation !== 'YES') {
					showError('Admin promotion cancelled');
					return;
				}
			} else {
				if (!confirm(`Are you sure you want to ${action} this user?`)) return;
			}

			try {
				const res = await fetch(`/api/admin/user/${discordId}/admin`, {
					method: 'POST',
					headers: { 'Content-Type': 'application/json' },
					body: JSON.stringify({ admin: makeAdmin })
				});
				const data = await res.json();

				if (res.ok) {
					const user = state.users.find(u => u.discordId === discordId);
					if (user) user.isAdmin = makeAdmin;
					renderUsers();
					showSuccess(data.message);
				} else {
					showError(data.error || 'Failed to update user');
				}
			} catch (err) {
				showError('Error: ' + err.message);
			}
		}

		function escapeHtml(text) {
			const div = document.createElement('div');
			div.textContent = text;
			return div.innerHTML;
		}

		function showSuccess(msg) {
			const container = document.querySelector('.admin-content');
			const el = document.createElement('div');
			el.className = 'success-msg';
			el.textContent = msg;
			container.insertBefore(el, container.firstChild);
			setTimeout(() => el.remove(), 3000);
		}

		function showError(msg) {
			const container = document.querySelector('.admin-content');
			const el = document.createElement('div');
			el.className = 'error-msg';
			el.textContent = msg;
			container.insertBefore(el, container.firstChild);
			setTimeout(() => el.remove(), 3000);
		}

		// Init
		async function init() {
			if (!(await checkAuth())) return;
			loadPosts();
			loadUsers();
		}

		init();
	</script>
	<div class="site-credits">Developer: <span>twizip</span> ‚Ä¢ Owner: <span>TheScrotchy</span> & <span>twizip</span></div>
</body>
</html>
