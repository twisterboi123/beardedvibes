<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>BeardedVibes</title>
  <link rel="stylesheet" href="/style.css">
</head>
<body class="youtube-layout">
  <header class="topbar">
    <div class="topbar-left">
      <button class="menu-toggle" id="menu-toggle">‚ò∞</button>
      <div class="logo">
        <span class="logo-icon">üî•</span>
        <span class="logo-text">BeardedVibes</span>
      </div>
    </div>
    <div class="topbar-center">
      <div class="search-box">
        <input type="text" placeholder="Search" id="search-input">
        <button class="search-btn">üîç</button>
      </div>
    </div>
    <div class="topbar-right">
      <button id="upload-btn" class="yt-btn">+ Create</button>
      <div id="notification-bell" class="notification-bell" style="display:none;">
        <button class="bell-btn" id="bell-btn">üîî<span class="badge" id="notif-badge" style="display:none;">0</span></button>
        <div class="notification-dropdown" id="notification-dropdown" style="display:none;">
          <div class="notif-header">
            <h4>Notifications</h4>
            <button id="mark-all-read" class="ghost-btn">Mark all read</button>
          </div>
          <div class="notif-list" id="notif-list"></div>
        </div>
      </div>
      <button id="login-btn" class="auth-btn">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="currentColor">
          <path d="M20.317 4.37a19.791 19.791 0 0 0-4.885-1.515.074.074 0 0 0-.079.037c-.21.375-.444.864-.608 1.25a18.27 18.27 0 0 0-5.487 0 12.64 12.64 0 0 0-.617-1.25.077.077 0 0 0-.079-.037A19.736 19.736 0 0 0 3.677 4.37a.07.07 0 0 0-.032.027C.533 9.046-.32 13.58.099 18.057a.082.082 0 0 0 .031.057 19.9 19.9 0 0 0 5.993 3.03.078.078 0 0 0 .084-.028c.462-.63.874-1.295 1.226-1.994a.076.076 0 0 0-.041-.106 13.107 13.107 0 0 1-1.872-.892.077.077 0 0 1-.008-.128 10.2 10.2 0 0 0 .372-.292.074.074 0 0 1 .077-.01c3.928 1.793 8.18 1.793 12.062 0a.074.074 0 0 1 .078.01c.12.098.246.198.373.292a.077.077 0 0 1-.006.127 12.299 12.299 0 0 1-1.873.892.077.077 0 0 0-.041.107c.36.698.772 1.362 1.225 1.993a.076.076 0 0 0 .084.028 19.839 19.839 0 0 0 6.002-3.03.077.077 0 0 0 .032-.054c.5-5.177-.838-9.674-3.549-13.66a.061.061 0 0 0-.031-.03zM8.02 15.33c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.956-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.956 2.418-2.157 2.418zm7.975 0c-1.183 0-2.157-1.085-2.157-2.419 0-1.333.955-2.419 2.157-2.419 1.21 0 2.176 1.096 2.157 2.42 0 1.333-.946 2.418-2.157 2.418z"/>
        </svg>
        Sign in
      </button>
      <div id="auth-menu" class="auth-menu" style="display:none;">
        <button class="auth-option" data-provider="discord">Sign in with Discord</button>
        <button class="auth-option" data-provider="google">Sign in with Google</button>
      </div>
      <div id="user-menu" class="user-menu" style="display:none;">
        <span id="user-avatar" class="user-avatar">üë§</span>
        <button id="logout-btn" class="ghost-btn">Sign out</button>
      </div>
    </div>
  </header>

  <div class="sidebar-overlay" id="sidebar-overlay"></div>
  <aside class="sidebar" id="sidebar">
    <nav class="sidebar-nav">
      <a href="#" class="nav-item active" data-feed="home">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Home</span>
      </a>
      <a href="#" class="nav-item" data-feed="trending">
        <span class="nav-icon">‚ö°</span>
        <span class="nav-label">Trending</span>
      </a>
      <a href="/shorts" class="nav-item">
        <span class="nav-icon">üé¨</span>
        <span class="nav-label">Shorts</span>
      </a>
      <hr class="nav-divider">
      <a href="#" class="nav-item" data-feed="history">
        <span class="nav-icon">üïê</span>
        <span class="nav-label">History</span>
      </a>
      <a href="#" class="nav-item" data-feed="watchlater">
        <span class="nav-icon">‚è∞</span>
        <span class="nav-label">Watch Later</span>
      </a>
      <a href="#" class="nav-item" data-feed="liked">
        <span class="nav-icon">üëç</span>
        <span class="nav-label">Liked</span>
      </a>
      <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--yt-border);">
      <a href="/admin.html" class="nav-item" id="admin-nav-item" style="display: none;">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="nav-label">Admin</span>
      </a>
    </nav>
  </aside>

  <main class="content">
    <div id="ban-message" class="ban-page" style="display:none;">
      <div class="ban-content">
        <h1>üö´ Account Banned</h1>
        <p>Your account has been banned and you cannot access this platform.</p>
        <p>If you believe this is a mistake, please contact support.</p>
        <button onclick="window.location.href='/api/auth/logout'" class="ghost-btn">Sign Out</button>
      </div>
    </div>
    <div id="loading" class="loading-state">
      <div class="spinner"></div>
      <p>Loading videos...</p>
    </div>
    <div id="grid" class="video-grid" style="display:none;"></div>
    <div id="empty" class="empty-state" style="display:none;">No uploads yet. Be the first to upload.</div>
  </main>

  <script>
    const loginBtn = document.getElementById('login-btn');
    const loading = document.getElementById('loading');
    const authMenu = document.getElementById('auth-menu');
    const logoutBtn = document.getElementById('logout-btn');
    const uploadBtn = document.getElementById('upload-btn');
    const userMenu = document.getElementById('user-menu');
    const userAvatar = document.getElementById('user-avatar');
    const menuToggle = document.getElementById('menu-toggle');
    const sidebar = document.getElementById('sidebar');
    const sidebarOverlay = document.getElementById('sidebar-overlay');
    const grid = document.getElementById('grid');
    const empty = document.getElementById('empty');
    const searchInput = document.getElementById('search-input');
    const searchBtn = document.querySelector('.search-btn');
    let currentUser = null;
    let currentFeed = 'home';
    let currentFormat = 'all';
    let isBanned = false;
    let searchTimeout = null;

    // Mobile sidebar toggle
    function toggleSidebar() {
      sidebar.classList.toggle('open');
      sidebarOverlay.classList.toggle('active');
    }
    
    function closeSidebar() {
      sidebar.classList.remove('open');
      sidebarOverlay.classList.remove('active');
    }
    
    menuToggle.addEventListener('click', toggleSidebar);
    sidebarOverlay.addEventListener('click', closeSidebar);

    // Search functionality
    async function performSearch(query) {
      if (!query || query.trim().length < 2) {
        loadFeed('home');
        return;
      }
      try {
        loading.style.display = 'flex';
        grid.style.display = 'none';
        empty.style.display = 'none';
        setActiveNav(null); // Clear active nav item

        const res = await fetch(`/api/posts/search?q=${encodeURIComponent(query.trim())}`);
        const data = await res.json();
        
        loading.style.display = 'none';
        grid.style.display = 'grid';
        
        if (!data.posts || data.posts.length === 0) {
          empty.textContent = `üîç No results found for "${query}"`;
          empty.style.display = 'flex';
          grid.innerHTML = '';
        } else {
          empty.style.display = 'none';
          render(data.posts);
        }
      } catch (err) {
        loading.style.display = 'none';
        empty.textContent = '‚ö†Ô∏è Search failed. Please try again.';
        empty.style.display = 'flex';
      }
    }

    searchBtn.addEventListener('click', () => {
      performSearch(searchInput.value);
    });

    searchInput.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        performSearch(searchInput.value);
      }
    });

    // Live search with debounce
    searchInput.addEventListener('input', () => {
      clearTimeout(searchTimeout);
      searchTimeout = setTimeout(() => {
        if (searchInput.value.trim().length >= 2) {
          performSearch(searchInput.value);
        } else if (searchInput.value.trim().length === 0) {
          loadFeed('home');
        }
      }, 500);
    });

    uploadBtn.addEventListener('click', () => {
      window.location.href = '/upload';
    });

    function toggleAuthMenu(show) {
      const shouldShow = typeof show === 'boolean' ? show : authMenu.style.display === 'none';
      authMenu.style.display = shouldShow ? 'flex' : 'none';
    }

    loginBtn.addEventListener('click', (e) => {
      e.preventDefault();
      toggleAuthMenu();
    });

    document.addEventListener('click', (e) => {
      if (!authMenu.contains(e.target) && e.target !== loginBtn) {
        toggleAuthMenu(false);
      }
    });

    authMenu.querySelectorAll('.auth-option').forEach((btn) => {
      btn.addEventListener('click', () => {
        const provider = btn.dataset.provider;
        toggleAuthMenu(false);
        if (provider === 'google') {
          window.location.href = '/api/auth/google';
          return;
        }
        window.location.href = '/api/auth/login';
      });
    });

    logoutBtn.addEventListener('click', async () => {
      await fetch('/api/auth/logout', { method: 'POST' });
      window.location.href = '/';
    });

    function setAvatar(el, url, fallback) {
      if (!el) return;
      el.innerHTML = '';
      if (url) {
        const img = document.createElement('img');
        img.src = url;
        img.alt = fallback || 'Avatar';
        el.appendChild(img);
        return;
      }
      el.textContent = (fallback || '?').slice(0, 2).toUpperCase();
    }

    function updateAuthUi() {
      if (currentUser) {
        loginBtn.style.display = 'none';
        toggleAuthMenu(false);
        userMenu.style.display = 'flex';
        document.getElementById('notification-bell').style.display = 'block';
        setAvatar(userAvatar, currentUser.avatar, currentUser.username || 'User');
        userAvatar.style.cursor = 'pointer';
        userAvatar.title = 'Open your profile';
        userAvatar.onclick = (e) => {
          e.stopPropagation();
          window.location.href = '/profile.html?id=me';
        };
        loadNotifications();
      } else {
        loginBtn.style.display = 'block';
        userMenu.style.display = 'none';
        document.getElementById('notification-bell').style.display = 'none';
      }
    }

    // Notifications
    const bellBtn = document.getElementById('bell-btn');
    const notifDropdown = document.getElementById('notification-dropdown');
    const notifBadge = document.getElementById('notif-badge');
    const notifList = document.getElementById('notif-list');
    const markAllRead = document.getElementById('mark-all-read');

    bellBtn.addEventListener('click', (e) => {
      e.stopPropagation();
      notifDropdown.style.display = notifDropdown.style.display === 'none' ? 'block' : 'none';
    });

    document.addEventListener('click', (e) => {
      if (!notifDropdown.contains(e.target) && e.target !== bellBtn) {
        notifDropdown.style.display = 'none';
      }
    });

    markAllRead.addEventListener('click', async () => {
      await fetch('/api/notifications/read-all', { method: 'POST' });
      notifBadge.style.display = 'none';
      document.querySelectorAll('.notif-item.unread').forEach(el => el.classList.remove('unread'));
    });

    async function loadNotifications() {
      try {
        const res = await fetch('/api/notifications');
        if (!res.ok) return;
        const data = await res.json();
        
        if (data.unreadCount > 0) {
          notifBadge.textContent = data.unreadCount > 99 ? '99+' : data.unreadCount;
          notifBadge.style.display = 'flex';
        } else {
          notifBadge.style.display = 'none';
        }
        
        notifList.innerHTML = '';
        if (data.notifications.length === 0) {
          notifList.innerHTML = '<div class="notif-empty">No notifications yet</div>';
          return;
        }
        
        data.notifications.forEach(n => {
          const item = document.createElement('div');
          item.className = `notif-item ${n.read ? '' : 'unread'} ${n.type === 'warning' ? 'warning' : ''}`;
          item.innerHTML = `
            <div class="title">${escapeHtml(n.title)}</div>
            <div class="message">${escapeHtml(n.message)}</div>
            <div class="time">${new Date(n.createdAt).toLocaleString()}</div>
          `;
          item.onclick = async () => {
            if (!n.read) {
              await fetch(`/api/notifications/${n.id}/read`, { method: 'POST' });
              item.classList.remove('unread');
              const currentCount = parseInt(notifBadge.textContent) || 0;
              if (currentCount > 1) {
                notifBadge.textContent = currentCount - 1;
              } else {
                notifBadge.style.display = 'none';
              }
            }
          };
          notifList.appendChild(item);
        });
      } catch (err) {
        console.error('Failed to load notifications:', err);
      }
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function formatDuration(seconds) {
      if (!seconds || seconds === 0) return '0:00';
      const mins = Math.floor(seconds / 60);
      const secs = Math.floor(seconds % 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function render(posts) {
      grid.innerHTML = '';
      // Filter to show only videos (exclude images)
      const filtered = posts
        .filter((p) => {
          const fmt = p.format || 'long';
          const isShort = fmt === 'short' && p.type === 'video';
          const isLongVideo = fmt === 'long' && p.type === 'video';
          
          if (currentFormat === 'all') return isLongVideo; // Only long-form videos on home
          if (currentFormat === 'short') return isShort;
          if (currentFormat === 'long') return isLongVideo;
          return false;
        });
      if (!filtered.length) {
        empty.style.display = 'block';
        return;
      }
      empty.style.display = 'none';
      filtered.forEach((p) => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.onclick = (e) => {
          if (e.target.closest('.channel-name, .channel-avatar')) return;
          window.location.href = `/post/${p.id}`;
        };

        const thumbWrap = document.createElement('div');
        thumbWrap.className = 'video-thumbnail';
        
        // Use thumbnail if available, otherwise use video/image
        const hasThumbnail = p.thumbnail && p.type === 'video';
        const thumb = document.createElement(hasThumbnail ? 'img' : (p.type === 'video' ? 'video' : 'img'));
        thumb.src = hasThumbnail ? p.thumbnail : p.fileUrl;
        thumb.loading = 'lazy';
        
        // Only show duration badge for videos
        let duration = null;
        if (p.type === 'video') {
          // Create duration badge for videos
          duration = document.createElement('span');
          duration.className = 'duration-badge';
          duration.textContent = '0:00'; // Placeholder until loaded
          
          if (hasThumbnail) {
            // For thumbnail images, we need to load video metadata separately
            const hiddenVideo = document.createElement('video');
            hiddenVideo.src = p.fileUrl;
            hiddenVideo.preload = 'metadata';
            hiddenVideo.addEventListener('loadedmetadata', () => {
              if (hiddenVideo.duration && !isNaN(hiddenVideo.duration) && isFinite(hiddenVideo.duration)) {
                duration.textContent = formatDuration(hiddenVideo.duration);
              }
            });
          } else {
            thumb.muted = true;
            thumb.preload = 'metadata';
            
            // Get actual duration when video metadata loads
            thumb.addEventListener('loadedmetadata', () => {
              if (thumb.duration && !isNaN(thumb.duration) && isFinite(thumb.duration)) {
                duration.textContent = formatDuration(thumb.duration);
              }
            });
            
            thumbWrap.addEventListener('mouseenter', () => {
              thumb.play().catch(() => {});
            });
            thumbWrap.addEventListener('mouseleave', () => {
              thumb.pause();
              thumb.currentTime = 0;
            });
          }
        }
        
        thumbWrap.appendChild(thumb);
        if (duration) thumbWrap.appendChild(duration);

        const info = document.createElement('div');
        info.className = 'video-info';

        const avatar = document.createElement('div');
        avatar.className = 'channel-avatar';
        setAvatar(avatar, p.uploaderAvatar, p.uploaderName || 'U');
        if (p.uploaderDiscordId) {
          avatar.style.cursor = 'pointer';
          avatar.title = 'View profile';
          avatar.onclick = (e) => {
            e.stopPropagation();
            window.location.href = `/profile.html?id=${p.uploaderDiscordId}`;
          };
        }

        const details = document.createElement('div');
        details.className = 'video-details';

        const title = document.createElement('h3');
        title.className = 'video-title';
        title.textContent = p.title || 'Untitled';

        const channelName = document.createElement('div');
        channelName.className = 'channel-name';
        const nameText = document.createElement('span');
        nameText.textContent = p.uploaderName || 'Unknown';
        channelName.appendChild(nameText);
        if (p.uploaderVerified) {
          const badge = document.createElement('span');
          badge.className = 'verified-badge';
          badge.innerHTML = '<svg viewBox="0 0 24 24"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Verified';
          channelName.appendChild(badge);
        }
        if (p.uploaderDiscordId) {
          channelName.style.cursor = 'pointer';
          channelName.onclick = (e) => {
            e.stopPropagation();
            window.location.href = `/profile.html?id=${p.uploaderDiscordId}`;
          };
        }

        const meta = document.createElement('div');
        meta.className = 'video-meta';
        meta.innerHTML = `<span>${p.likes || 0} likes</span> ‚Ä¢ <span>${new Date(p.createdAt).toLocaleDateString()}</span>`;

        details.append(title, channelName, meta);
        info.append(avatar, details);
        card.append(thumbWrap, info);
        grid.appendChild(card);
      });
    }

    async function load() {
      return loadFeed('home');
    }

    function setActiveNav(feed) {
      document.querySelectorAll('.sidebar .nav-item').forEach((el) => {
        el.classList.toggle('active', el.dataset.feed === feed);
      });
    }

    async function fetchPostsForFeed(feed) {
      const endpoint = (
        feed === 'home' ? '/api/posts' :
        feed === 'trending' ? '/api/posts/trending' :
        feed === 'liked' ? '/api/posts/liked' :
        feed === 'history' ? '/api/posts/history' :
        feed === 'watchlater' ? '/api/posts/watchlater' :
        '/api/posts'
      );
      const res = await fetch(endpoint);
      if (!res.ok) {
        if (res.status === 401) {
          window.location.href = '/api/auth/login';
          return { posts: [] };
        }
        throw new Error('Failed to load posts');
      }
      return res.json();
    }

    async function loadFeed(feed) {
      try {
        currentFeed = feed;
        setActiveNav(feed);
        loading.style.display = 'flex';
        grid.style.display = 'none';
        empty.style.display = 'none';

        const data = await fetchPostsForFeed(feed);
        // cache for format filtering without refetching
        window.__lastPosts = data.posts || [];

        setTimeout(() => {
          loading.style.display = 'none';
          grid.style.display = 'grid';
          render(window.__lastPosts);

          // Animate cards in
          const cards = document.querySelectorAll('.video-card');
          cards.forEach((card, i) => {
            card.style.opacity = '0';
            card.style.transform = 'translateY(20px)';
            setTimeout(() => {
              card.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
              card.style.opacity = '1';
              card.style.transform = 'translateY(0)';
            }, i * 50);
          });
        }, 300);
      } catch (err) {
        loading.style.display = 'none';
        empty.textContent = '‚ö†Ô∏è Could not load videos. Please try again.';
        empty.style.display = 'flex';
      }
    }

    function wireFormatTabs() {
      const tabs = document.querySelectorAll('#format-tabs .tab');
      tabs.forEach((tab) => {
        tab.addEventListener('click', (e) => {
          e.preventDefault();
          const fmt = tab.dataset.format || 'all';
          currentFormat = fmt;
          tabs.forEach((t) => t.classList.toggle('active', t === tab));
          // Re-render with the already-fetched posts currently in the DOM
          const cardsData = window.__lastPosts || [];
          render(cardsData);
        });
      });
    }

    async function loadUser() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) {
          if (res.status === 403) {
            const data = await res.json().catch(() => ({}));
            if (data.banned) {
              isBanned = true;
              return;
            }
          }
          throw new Error('Not logged in');
        }
        const data = await res.json();
        currentUser = data.user;

        // Show admin link if user is admin
        if (currentUser?.isAdmin) {
          document.getElementById('admin-nav-item').style.display = 'flex';
        }
      } catch (_err) {
        currentUser = null;
      }
      updateAuthUi();
    }

    async function bootstrap() {
      await loadUser();
      
      // Show ban message and hide everything else if banned
      if (isBanned) {
        document.getElementById('ban-message').style.display = 'flex';
        document.querySelector('.topbar').style.opacity = '0.5';
        document.querySelector('.sidebar').style.opacity = '0.5';
        document.getElementById('loading').style.display = 'none';
        document.getElementById('grid').style.display = 'none';
        document.getElementById('upload-btn').disabled = true;
        document.querySelector('.nav-item').style.pointerEvents = 'none';
        return;
      }
      
      await load();
      wireFormatTabs();

      // Wire sidebar navigation
      document.querySelectorAll('.sidebar .nav-item').forEach((item) => {
        item.addEventListener('click', (e) => {
          // Skip items that should navigate normally (like admin, shorts)
          if (!item.dataset.feed) return;
          
          e.preventDefault();
          const feed = item.dataset.feed;
          if (['liked', 'history', 'watchlater'].includes(feed) && !currentUser) {
            window.location.href = '/api/auth/login';
            return;
          }
          // Clear search when navigating feeds
          searchInput.value = '';
          loadFeed(feed || 'home');
          
          // Close sidebar on mobile
          closeSidebar();
        });
      });
    }

    bootstrap();
  </script>
  <div class="site-credits">
    Developer: <span>twizip</span> ‚Ä¢ Owner: <span>TheScrotchy</span> & <span>twizip</span>
    <div class="guidelines-notice">By using this website, you agree to our <a href="/guidelines.html">Community Guidelines</a></div>
  </div>
</body>
</html>
