<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Profile – BeardedVibes</title>

<style>
:root{
  --bg:#0f0f0f;
  --bg2:#181818;
  --border:#2a2a2a;
  --text:#f1f1f1;
  --text2:#aaa;
  --accent:#3ea6ff;
}

*{box-sizing:border-box;font-family:system-ui,-apple-system,Segoe UI,Roboto}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
}

a{color:inherit;text-decoration:none}

/* TOP BAR */
.topbar{
  height:56px;
  display:flex;
  align-items:center;
  justify-content:space-between;
  padding:0 16px;
  background:var(--bg2);
  border-bottom:1px solid var(--border);
}

.logo{
  font-weight:700;
  font-size:18px;
}

.avatar{
  width:36px;
  height:36px;
  border-radius:50%;
  overflow:hidden;
  background:linear-gradient(135deg,#667eea,#764ba2);
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  cursor:pointer;
}

/* PROFILE HEADER */
.profile-header{
  background:var(--bg2);
  border-bottom:1px solid var(--border);
}

.profile-inner{
  max-width:1200px;
  margin:auto;
  padding:20px;
  display:flex;
  gap:16px;
  align-items:center;
}

.profile-pfp{
  width:96px;
  height:96px;
  border-radius:50%;
  overflow:hidden;
  background:linear-gradient(135deg,#667eea,#764ba2);
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:40px;
  font-weight:700;
}

.profile-info{
  flex:1;
}

.profile-info h1{
  margin:0;
  font-size:24px;
}

.handle{
  color:var(--text2);
  font-size:14px;
}

.stats{
  display:flex;
  gap:16px;
  margin-top:6px;
  font-size:14px;
  color:var(--text2);
}

.btn{
  padding:10px 16px;
  border:none;
  border-radius:20px;
  background:var(--accent);
  color:#000;
  font-weight:600;
  cursor:pointer;
}

/* TABS */
.tabs{
  display:flex;
  gap:32px;
  padding:0 20px;
  background:var(--bg2);
  border-bottom:1px solid var(--border);
}

.tab{
  padding:14px 0;
  cursor:pointer;
  color:var(--text2);
  border-bottom:3px solid transparent;
}

.tab.active{
  color:var(--text);
  border-color:var(--accent);
}

/* CONTENT */
.content{
  max-width:1200px;
  margin:auto;
  padding:20px;
}

.grid{
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(240px,1fr));
  gap:16px;
}

.card{
  cursor:pointer;
}

.thumb{
  width:100%;
  aspect-ratio:16/9;
  background:#000;
  border-radius:12px;
  overflow:hidden;
}

.thumb img,
.thumb video{
  width:100%;
  height:100%;
  object-fit:cover;
}

.title{
  margin:8px 0 2px;
  font-size:15px;
}

.meta{
  color:var(--text2);
  font-size:13px;
}
</style>
</head>

<body>

<header class="topbar">
  <a class="logo" href="/">BeardedVibes</a>
  <div class="avatar" id="top-avatar">U</div>
</header>

<section class="profile-header">
  <div class="profile-inner">
    <div class="profile-pfp" id="pfp">U</div>

    <div class="profile-info">
      <h1 id="username">Loading…</h1>
      <div class="handle" id="handle">@user</div>
      <div class="stats">
        <div><b id="videos">0</b> videos</div>
        <div><b id="followers">0</b> subscribers</div>
        <div><b id="likes">0</b> likes</div>
      </div>
    </div>

    <button class="btn" id="editBtn">Edit profile</button>
  </div>
</section>

<nav class="tabs">
  <div class="tab active" data-tab="videos">Videos</div>
  <div class="tab" data-tab="shorts">Shorts</div>
</nav>

<main class="content">
  <div id="videosTab" class="grid"></div>
  <div id="shortsTab" class="grid" style="display:none"></div>
</main>

<script>
let currentUser = null;
let profileData = null;

/* LOAD CURRENT USER */
async function loadUser(){
  try{
    const res = await fetch('/api/auth/me');
    if(!res.ok) throw new Error('Not logged in');
    const data = await res.json();
    currentUser = data.user;
    setAvatar(topAvatar, currentUser.avatar, currentUser.username);
  }catch(e){
    topAvatar.textContent = 'U';
  }
}

/* LOAD PROFILE */
async function loadProfile(){
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  const isSelf = !id || id === 'me';

  if(isSelf && !currentUser){
    username.textContent = 'Not logged in';
    handle.textContent = 'Please sign in';
    return;
  }

  const endpoint = isSelf ? '/api/me/profile' : `/api/user/${id}/profile`;

  try{
    const res = await fetch(endpoint);
    if(!res.ok) throw new Error('Profile not found');
    profileData = await res.json();
    
    username.textContent = profileData.username || 'User';
    handle.textContent = '@' + (profileData.discordId || 'user');
    videos.textContent = profileData.totalVideos || 0;
    followers.textContent = profileData.followerCount || 0;
    likes.textContent = profileData.totalLikes || 0;

    setAvatar(pfp, profileData.avatar, profileData.username);

    // Show/hide edit button
    const isOwn = currentUser && currentUser.discordId === profileData.discordId;
    editBtn.style.display = isOwn ? 'block' : 'none';

    // Add verified badge if verified
    if(profileData.isVerified){
      const badge = document.createElement('span');
      badge.style.cssText = 'background:#3ea6ff;color:#000;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;margin-left:8px';
      badge.textContent = '✓ VERIFIED';
      username.appendChild(badge);
    }

    renderContent();
  }catch(e){
    username.textContent = 'Error loading profile';
    console.error(e);
  }
}

/* SET AVATAR */
function setAvatar(el, url, name){
  el.innerHTML = '';
  if(url){
    const img = document.createElement('img');
    img.src = url;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    el.appendChild(img);
  }else{
    el.textContent = (name || 'U').charAt(0).toUpperCase();
  }
}

/* RENDER CONTENT */
function renderContent(){
  videosTab.innerHTML = "";
  shortsTab.innerHTML = "";

  if(!profileData || !profileData.videos) return;

  const videoList = profileData.videos.filter(v => v.format !== 'short');
  const shortList = profileData.videos.filter(v => v.format === 'short');

  videoList.forEach(v=>{
    const card = createCard(v);
    videosTab.appendChild(card);
  });

  shortList.forEach(v=>{
    const card = createCard(v);
    shortsTab.appendChild(card);
  });

  if(videoList.length === 0) videosTab.innerHTML = '<p style="color:var(--text2)">No videos yet</p>';
  if(shortList.length === 0) shortsTab.innerHTML = '<p style="color:var(--text2)">No shorts yet</p>';
}

function createCard(v){
  const card = document.createElement("div");
  card.className = "card";
  card.onclick = () => window.location.href = `/post/${v.id}`;
  card.innerHTML = `
    <div class="thumb">
      ${v.type === 'video' ? `<video src="${v.fileUrl || v.filename}"></video>` : `<img src="${v.fileUrl || v.filename}">`}
    </div>
    <div class="title">${escapeHtml(v.title || 'Untitled')}</div>
    <div class="meta">${v.likes || 0} likes • ${new Date(v.createdAt).toLocaleDateString()}</div>
  `;
  return card;
}

function escapeHtml(text){
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* TABS */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    videosTab.style.display = tab.dataset.tab==="videos"?"grid":"none";
    shortsTab.style.display = tab.dataset.tab==="shorts"?"grid":"none";
  };
});

/* EDIT BUTTON */
editBtn.onclick = () => {
  window.location.href = '/profile-edit.html';
};

/* TOP AVATAR CLICK */
topAvatar.onclick = () => {
  if(currentUser) window.location.href = '/profile.html?id=me';
  else window.location.href = '/api/auth/login';
};

/* INIT */
async function init(){
  await loadUser();
  await loadProfile();
}

init();
</script>

</body>
</html>
