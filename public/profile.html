<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Profile - BeardedVibes</title>
  <link rel="stylesheet" href="/style.css" />
</head>
<body>
  <header class="topbar">
    <div class="topbar-left">
      <button id="menu-btn" class="icon-btn" aria-label="Menu">‚ò∞</button>
      <a href="/" class="logo">BeardedVibes</a>
    </div>
    <div class="topbar-right">
      <div class="user-menu" id="user-menu">
        <div class="user-avatar" id="user-avatar"></div>
      </div>
    </div>
  </header>

  <aside class="sidebar" id="sidebar">
    <nav class="sidebar-nav">
      <a href="/" class="nav-item">
        <span class="nav-icon">üè†</span>
        <span class="nav-label">Home</span>
      </a>
      <a href="/shorts.html" class="nav-item">
        <span class="nav-icon">üì±</span>
        <span class="nav-label">Shorts</span>
      </a>
      <a href="#" class="nav-item" data-feed="trending">
        <span class="nav-icon">üî•</span>
        <span class="nav-label">Trending</span>
      </a>
      <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--yt-border);">
      <a href="#" class="nav-item" data-feed="history">
        <span class="nav-icon">üïê</span>
        <span class="nav-label">History</span>
      </a>
      <a href="#" class="nav-item" data-feed="watchlater">
        <span class="nav-icon">‚è∞</span>
        <span class="nav-label">Watch Later</span>
      </a>
      <a href="#" class="nav-item" data-feed="liked">
        <span class="nav-icon">üëç</span>
        <span class="nav-label">Liked</span>
      </a>
      <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--yt-border);">
      <a href="/admin.html" class="nav-item" id="admin-nav-item" style="display: none;">
        <span class="nav-icon">‚öôÔ∏è</span>
        <span class="nav-label">Admin</span>
      </a>
    </nav>
  </aside>

  <main class="content" style="padding: 20px;">
    <div id="profile-container" style="max-width: 1200px; margin: 0 auto;">
      <div class="loading-state">Loading profile...</div>
    </div>
  </main>

  <script>
    const sidebar = document.getElementById('sidebar');
    const menuBtn = document.getElementById('menu-btn');
    const userMenu = document.getElementById('user-menu');
    const userAvatar = document.getElementById('user-avatar');

    menuBtn.addEventListener('click', () => {
      sidebar.classList.toggle('collapsed');
    });

    let currentUser = null;
    let currentProfileId = null;

    function setAvatar(el, url, fallback) {
      el.innerHTML = '';
      if (url) {
        const img = document.createElement('img');
        img.src = url;
        img.alt = fallback || 'Avatar';
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'cover';
        el.appendChild(img);
      } else {
        el.textContent = (fallback || 'U').charAt(0).toUpperCase();
        el.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
        el.style.display = 'flex';
        el.style.alignItems = 'center';
        el.style.justifyContent = 'center';
        el.style.color = 'white';
        el.style.fontWeight = '600';
      }
    }

    async function loadUser() {
      try {
        const res = await fetch('/api/auth/me');
        if (!res.ok) throw new Error('Not logged in');
        const data = await res.json();
        currentUser = data.user;

        if (currentUser?.isAdmin) {
          document.getElementById('admin-nav-item').style.display = 'flex';
        }
      } catch (_err) {
        currentUser = null;
      }
      updateAuthUi();
    }

    function updateAuthUi() {
      if (currentUser) {
        userMenu.style.display = 'flex';
        setAvatar(userAvatar, currentUser.avatar, currentUser.username || 'User');
        userMenu.title = 'View or edit your profile';
        userMenu.onclick = () => {
          window.location.href = '/profile.html?id=me';
        };
      } else {
        userMenu.innerHTML = '<a href="/api/auth/login" class="login-btn">Login</a>';
      }
    }

    async function loadProfile() {
      const params = new URLSearchParams(window.location.search);
      const requestedId = params.get('id');
      const wantsSelf = !requestedId || requestedId === 'me' || requestedId === 'self';

      if (wantsSelf && !currentUser) {
        document.getElementById('profile-container').innerHTML = '<div style="text-align: center; padding: 40px;"><h2>Login required</h2><p><a href="/api/auth/login" class="login-btn">Sign in</a> to view your profile.</p></div>';
        return;
      }

      const discordId = wantsSelf ? currentUser?.discordId : requestedId;

      if (!discordId) {
        document.getElementById('profile-container').innerHTML = '<div style="text-align: center; padding: 40px;"><h2>Profile not found</h2><p>No user specified.</p></div>';
        return;
      }

      currentProfileId = discordId;
      const endpoint = wantsSelf ? '/api/me/profile' : `/api/user/${discordId}/profile`;

      try {
        const res = await fetch(endpoint);
        if (!res.ok) throw new Error('Profile not found');
        const data = await res.json();
        renderProfile(data, wantsSelf && currentUser && currentUser.discordId === discordId);
      } catch (err) {
        document.getElementById('profile-container').innerHTML = `<div style="text-align: center; padding: 40px;"><h2>Error</h2><p>${err.message}</p></div>`;
      }
    }

    function renderProfile(data, isOwn) {
      const container = document.getElementById('profile-container');
      const safeName = escapeHtml(data.username || 'User');
      const safeInitial = safeName.charAt(0).toUpperCase();
      const safeHandle = escapeHtml(data.discordId || '');
      
      const header = `
        <div class="profile-header">
          <div class="profile-avatar">
            ${data.avatar ? `<img src="${data.avatar}" alt="${safeName}">` : `<div class="avatar-placeholder">${safeInitial}</div>`}
          </div>
          <div class="profile-meta">
            <div class="profile-name-row">
              <h1>${safeName}</h1>
              ${data.isVerified ? '<span class="verified-badge">‚úì</span>' : ''}
            </div>
            <p class="profile-handle">@${safeHandle}</p>
            <div class="profile-stats">
              <div><strong>${data.totalVideos || 0}</strong><span>videos</span></div>
              <div><strong>${data.totalLikes || 0}</strong><span>likes</span></div>
              <div><strong>${data.followerCount || 0}</strong><span>followers</span></div>
            </div>
          </div>
        </div>
      `;

      const editPanel = isOwn ? `
        <section class="profile-edit-card">
          <div class="edit-card-header">
            <div>
              <p class="eyebrow">Your profile</p>
              <h2>Update name & avatar</h2>
            </div>
            <span class="pill pill-subtle">Visible across the site</span>
          </div>
          <form id="profile-edit-form" class="profile-edit-form">
            <div class="form-row">
              <label for="display-name">Display name</label>
              <input id="display-name" name="username" type="text" maxlength="80" placeholder="How should people see you?" value="${escapeAttribute(data.username)}">
            </div>
            <div class="form-row">
              <label>Profile picture</label>
              <div class="avatar-picker">
                <div id="avatar-preview" class="avatar-preview">${data.avatar ? `<img src="${data.avatar}" alt="Avatar preview">` : `<div class="avatar-fallback">${safeInitial}</div>`}</div>
                <div class="avatar-actions">
                  <input id="avatar-input" name="avatar" type="file" accept="image/*" style="display:none;">
                  <button type="button" id="pick-avatar" class="ghost-btn">Choose image</button>
                  <p class="hint">PNG, JPG, or WebP up to 5 MB.</p>
                </div>
              </div>
            </div>
            <div class="form-actions">
              <button type="submit" class="primary-btn">Save changes</button>
              <span id="profile-edit-status" class="status-text"></span>
            </div>
          </form>
        </section>
      ` : '';

      const videosSection = `
        <section>
          <div class="section-header">
            <h2>Videos</h2>
            <span class="pill">${data.totalVideos || 0} total</span>
          </div>
          <div class="video-grid" id="videos-grid">
            ${data.videos && data.videos.length > 0 ? data.videos.map(v => `
              <div class="video-card" onclick="window.location.href='/post.html?id=${v.id}'">
                <div class="thumbnail-wrapper">
                  ${v.type === 'video' ? `<video src="${v.fileUrl || v.filename}" class="thumbnail"></video>` : `<img src="${v.fileUrl || v.filename}" class="thumbnail" alt="${escapeHtml(v.title || 'Untitled')}">`}
                  <div class="duration-badge">${v.format === 'short' ? 'Short' : 'Video'}</div>
                </div>
                <div class="video-info">
                  <h3 class="video-title">${escapeHtml(v.title || 'Untitled')}</h3>
                  <div class="video-meta">
                    <span>${v.likes || 0} likes</span> ‚Ä¢ <span>${new Date(v.createdAt).toLocaleDateString()}</span>
                  </div>
                </div>
              </div>
            `).join('') : '<p style="color: var(--yt-text-secondary);">No videos yet</p>'}
          </div>
        </section>
      `;

      container.innerHTML = header + editPanel + videosSection;

      if (isOwn) {
        wireProfileForm(data);
      }
    }

    function wireProfileForm(data) {
      const form = document.getElementById('profile-edit-form');
      const nameInput = document.getElementById('display-name');
      const fileInput = document.getElementById('avatar-input');
      const pickBtn = document.getElementById('pick-avatar');
      const preview = document.getElementById('avatar-preview');
      const status = document.getElementById('profile-edit-status');

      pickBtn.addEventListener('click', () => fileInput.click());

      fileInput.addEventListener('change', () => {
        const file = fileInput.files?.[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        preview.innerHTML = `<img src="${url}" alt="Avatar preview">`;
      });

      form.addEventListener('submit', async (e) => {
        e.preventDefault();
        status.textContent = '';

        const fd = new FormData();
        const nextName = nameInput.value.trim();
        if (nextName && nextName !== data.username) fd.append('username', nextName);
        if (fileInput.files?.[0]) fd.append('avatar', fileInput.files[0]);

        if (!fd.has('username') && !fd.has('avatar')) {
          status.textContent = 'Nothing to update.';
          return;
        }

        try {
          status.textContent = 'Saving...';
          const res = await fetch('/api/me/profile', {
            method: 'PATCH',
            body: fd
          });
          if (!res.ok) {
            const err = await res.json().catch(() => ({}));
            throw new Error(err.error || 'Failed to save');
          }
          status.textContent = 'Saved!';
          await loadUser();
          await loadProfile();
        } catch (err) {
          status.textContent = err.message;
        }
      });
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeAttribute(text) {
      return escapeHtml(text || '');
    }

    async function init() {
      await loadUser();
      await loadProfile();
    }

    init();
  </script>
</body>
</html>
