<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Profile ‚Äì BeardedVibes</title>
<link rel="stylesheet" href="/style.css">
<style>
/* Profile Page Styles */
.profile-banner {
  width: 100%;
  height: 200px;
  background-size: cover;
  background-position: center;
  background-color: #1a1a2e;
}

.profile-header {
  background: linear-gradient(180deg, #1a1a2e 0%, #0f0f0f 100%);
  border-bottom: 1px solid var(--yt-border);
}

.profile-inner {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 20px;
  display: flex;
  gap: 20px;
  align-items: center;
}

.bio {
  color: var(--yt-text-secondary);
  font-size: 14px;
  margin-top: 8px;
  max-width: 500px;
  line-height: 1.5;
}

.profile-pfp {
  width: 120px;
  height: 120px;
  border-radius: 50%;
  overflow: hidden;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 48px;
  font-weight: 700;
  color: #fff;
  flex-shrink: 0;
  box-shadow: 0 4px 20px rgba(102, 126, 234, 0.3);
}

.profile-pfp img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.profile-info {
  flex: 1;
  min-width: 0;
}

.profile-info h1 {
  margin: 0;
  font-size: 26px;
  color: var(--yt-text);
  display: flex;
  align-items: center;
  gap: 10px;
  flex-wrap: wrap;
}

.verified-badge {
  display: inline-flex;
  align-items: center;
  gap: 4px;
  background: linear-gradient(135deg, #1d9bf0, #3ea6ff);
  color: #ffffff !important;
  padding: 4px 12px;
  border-radius: 12px;
  font-size: 12px;
  font-weight: 700;
  white-space: nowrap;
  text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
  box-shadow: 0 2px 8px rgba(29, 155, 240, 0.5);
  letter-spacing: 0.3px;
}

.verified-badge svg {
  width: 14px;
  height: 14px;
  fill: #ffffff !important;
  flex-shrink: 0;
}

.handle {
  color: var(--yt-text-secondary);
  font-size: 14px;
  margin-top: 6px;
}

.stats {
  display: flex;
  gap: 20px;
  margin-top: 12px;
  font-size: 14px;
  color: var(--yt-text-secondary);
}

.stats b {
  color: var(--yt-text);
  font-weight: 600;
}

.profile-actions {
  display: flex;
  gap: 10px;
  flex-shrink: 0;
}

.btn {
  padding: 10px 20px;
  border: none;
  border-radius: 20px;
  background: var(--yt-accent);
  color: #000;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
  transition: all 0.2s;
}

.btn:hover {
  background: #5db3ff;
  transform: translateY(-1px);
}

.btn-secondary {
  background: transparent;
  border: 1px solid var(--yt-border);
  color: var(--yt-text);
}

.btn-secondary:hover {
  background: var(--yt-hover);
}

/* Tabs */
.profile-tabs {
  display: flex;
  gap: 0;
  padding: 0 20px;
  background: var(--yt-bg);
  border-bottom: 1px solid var(--yt-border);
  max-width: 1200px;
  margin: 0 auto;
}

.tab {
  padding: 16px 24px;
  cursor: pointer;
  color: var(--yt-text-secondary);
  border-bottom: 3px solid transparent;
  font-weight: 500;
  font-size: 15px;
  transition: all 0.2s;
}

.tab:hover {
  color: var(--yt-text);
  background: var(--yt-hover);
}

.tab.active {
  color: var(--yt-text);
  border-color: var(--yt-accent);
}

/* Content Grid */
.profile-content {
  max-width: 1200px;
  margin: 0 auto;
  padding: 24px 20px;
}

.grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 20px;
}

.card {
  cursor: pointer;
  transition: transform 0.2s, box-shadow 0.2s;
  border-radius: 12px;
}

.card:hover {
  transform: translateY(-4px);
}

.thumb {
  width: 100%;
  aspect-ratio: 16/9;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
  position: relative;
}

.thumb img,
.thumb video {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.card .title {
  margin: 10px 0 4px;
  font-size: 15px;
  font-weight: 500;
  color: var(--yt-text);
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.card .meta {
  color: var(--yt-text-secondary);
  font-size: 13px;
}

/* Edit Form */
.edit-form {
  background: var(--yt-bg-secondary, #181818);
  border: 1px solid var(--yt-border);
  border-radius: 12px;
  padding: 24px;
  margin-bottom: 24px;
}

.edit-form h2 {
  margin: 0 0 20px;
  font-size: 18px;
  color: var(--yt-text);
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  color: var(--yt-text);
  font-weight: 500;
}

.form-group input[type="text"],
.form-group input[type="file"] {
  width: 100%;
  padding: 12px;
  background: var(--yt-bg);
  border: 1px solid var(--yt-border);
  border-radius: 8px;
  color: var(--yt-text);
  font-size: 14px;
  transition: border-color 0.2s;
}

.form-group input:focus {
  outline: none;
  border-color: var(--yt-accent);
}

.form-actions {
  display: flex;
  gap: 12px;
  align-items: center;
}

.save-status {
  color: var(--yt-text-secondary);
  font-size: 14px;
}

/* Empty State */
.empty-message {
  text-align: center;
  padding: 60px 20px;
  color: var(--yt-text-secondary);
}

.empty-message p {
  font-size: 16px;
}

/* Responsive */
@media (max-width: 640px) {
  .profile-inner {
    flex-direction: column;
    text-align: center;
  }
  
  .profile-pfp {
    width: 100px;
    height: 100px;
    font-size: 40px;
  }
  
  .profile-info h1 {
    justify-content: center;
    font-size: 22px;
  }
  
  .stats {
    justify-content: center;
  }
  
  .profile-actions {
    width: 100%;
    justify-content: center;
  }
  
  .grid {
    grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
    gap: 12px;
  }
}
</style>
</head>

<body class="youtube-layout">

<header class="topbar">
  <div class="topbar-left">
    <button id="menu-btn" class="icon-btn" aria-label="Menu">‚ò∞</button>
    <a class="logo" href="/">BeardedVibes</a>
  </div>
  <div class="topbar-right">
    <div class="user-menu">
      <div class="user-avatar" id="top-avatar"></div>
    </div>
  </div>
</header>

<aside class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <a href="/" class="nav-item">
      <span class="nav-icon">üè†</span>
      <span class="nav-label">Home</span>
    </a>
    <a href="/shorts.html" class="nav-item">
      <span class="nav-icon">üì±</span>
      <span class="nav-label">Shorts</span>
    </a>
    <a href="#" class="nav-item">
      <span class="nav-icon">üî•</span>
      <span class="nav-label">Trending</span>
    </a>
    <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--yt-border);">
    <a href="#" class="nav-item">
      <span class="nav-icon">üïê</span>
      <span class="nav-label">History</span>
    </a>
    <a href="#" class="nav-item">
      <span class="nav-icon">‚è∞</span>
      <span class="nav-label">Watch Later</span>
    </a>
    <a href="#" class="nav-item">
      <span class="nav-icon">üëç</span>
      <span class="nav-label">Liked</span>
    </a>
    <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--yt-border);">
    <a href="/admin.html" class="nav-item" id="admin-nav-item" style="display: none;">
      <span class="nav-icon">‚öôÔ∏è</span>
      <span class="nav-label">Admin</span>
    </a>
  </nav>
</aside>

<main class="content" style="padding: 0;">
<div id="profile-banner" class="profile-banner" style="display:none;"></div>
<section class="profile-header" id="profile-header-section">
  <div class="profile-inner">
    <div class="profile-pfp" id="pfp">U</div>
    <div class="profile-info">
      <h1 id="username">Loading‚Ä¶</h1>
      <div class="handle" id="handle">@user</div>
      <div class="bio" id="bio" style="display:none;"></div>
      <div class="stats">
        <div><b id="videos">0</b> videos</div>
        <div><b id="followers">0</b> subscribers</div>
        <div><b id="likes">0</b> likes</div>
      </div>
    </div>
    <div class="profile-actions">
      <button class="btn" id="editBtn" style="display:none;">Edit profile</button>
    </div>
  </div>
</section>

<nav class="profile-tabs">
  <div class="tab active" data-tab="videos">Videos</div>
  <div class="tab" data-tab="shorts">Shorts</div>
</nav>

<div class="profile-content">
  <div id="editForm" class="edit-form" style="display:none;">
    <h2>Edit Profile</h2>
    <form id="profileForm">
      <div class="form-group">
        <label for="nameInput">Display Name</label>
        <input id="nameInput" type="text" maxlength="80" placeholder="Your display name">
      </div>
      <div class="form-group">
        <label for="bioInput">Bio</label>
        <textarea id="bioInput" maxlength="500" placeholder="Tell people about yourself" rows="3" style="width:100%; padding:12px; background:var(--yt-bg); border:1px solid var(--yt-border); border-radius:8px; color:var(--yt-text); font-size:14px; resize:vertical;"></textarea>
      </div>
      <div class="form-group">
        <label for="avatarInput">Profile Picture</label>
        <input id="avatarInput" type="file" accept="image/*">
      </div>
      <div class="form-group">
        <label for="bannerInput">Banner Image URL</label>
        <input id="bannerInput" type="text" placeholder="https://example.com/banner.jpg">
      </div>
      <div class="form-group">
        <label for="colorInput">Profile Accent Color</label>
        <div style="display:flex; gap:12px; align-items:center;">
          <input id="colorInput" type="color" value="#3ea6ff" style="width:60px; height:40px; border:none; background:none; cursor:pointer;">
          <span id="colorPreview" style="padding:8px 16px; border-radius:20px; font-weight:600; font-size:13px;">Preview</span>
        </div>
      </div>
      <div class="form-actions">
        <button type="submit" class="btn">Save Changes</button>
        <button type="button" id="cancelEdit" class="btn btn-secondary">Cancel</button>
        <span id="saveStatus" class="save-status"></span>
      </div>
    </form>
  </div>

  <div id="videosTab" class="grid"></div>
  <div id="shortsTab" class="grid" style="display:none"></div>
</div>
</main>

<script>
const sidebar = document.getElementById('sidebar');
const menuBtn = document.getElementById('menu-btn');
const topAvatar = document.getElementById('top-avatar');

menuBtn.addEventListener('click', () => {
  sidebar.classList.toggle('collapsed');
});

let currentUser = null;
let profileData = null;

/* LOAD CURRENT USER */
async function loadUser(){
  try{
    const res = await fetch('/api/auth/me');
    if(!res.ok) throw new Error('Not logged in');
    const data = await res.json();
    currentUser = data.user;
    setAvatar(topAvatar, currentUser.avatar, currentUser.username);
    
    if(currentUser?.isAdmin){
      document.getElementById('admin-nav-item').style.display = 'flex';
    }
    
    topAvatar.onclick = () => window.location.href = '/profile.html?id=me';
  }catch(e){
    topAvatar.textContent = 'U';
    topAvatar.onclick = () => window.location.href = '/api/auth/login';
  }
}

/* LOAD PROFILE */
async function loadProfile(){
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  const isSelf = !id || id === 'me';

  if(isSelf && !currentUser){
    username.textContent = 'Not logged in';
    handle.textContent = 'Please sign in';
    return;
  }

  const endpoint = isSelf ? '/api/me/profile' : `/api/user/${id}/profile`;

  try{
    const res = await fetch(endpoint);
    if(!res.ok) throw new Error('Profile not found');
    profileData = await res.json();
    
    username.innerHTML = '';
    const nameSpan = document.createElement('span');
    nameSpan.textContent = profileData.username || 'User';
    username.appendChild(nameSpan);
    if (profileData.isVerified) {
      const badge = document.createElement('span');
      badge.className = 'verified-badge';
      badge.innerHTML = '<svg viewBox="0 0 24 24" style="width:12px;height:12px;fill:currentColor"><path d="M9 16.17L4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>Verified';
      username.appendChild(badge);
    }
    handle.textContent = '@' + (profileData.discordId || 'user');
    videos.textContent = profileData.totalVideos || 0;
    followers.textContent = profileData.followerCount || 0;
    likes.textContent = profileData.totalLikes || 0;

    // Show bio if exists
    const bioEl = document.getElementById('bio');
    if (profileData.bio) {
      bioEl.textContent = profileData.bio;
      bioEl.style.display = 'block';
    } else {
      bioEl.style.display = 'none';
    }

    // Show banner if exists
    const bannerEl = document.getElementById('profile-banner');
    if (profileData.banner) {
      bannerEl.style.backgroundImage = `url(${profileData.banner})`;
      bannerEl.style.display = 'block';
    } else {
      bannerEl.style.display = 'none';
    }

    // Apply profile color
    const headerSection = document.getElementById('profile-header-section');
    if (profileData.profileColor) {
      headerSection.style.background = `linear-gradient(180deg, ${profileData.profileColor}22 0%, #0f0f0f 100%)`;
      pfp.style.boxShadow = `0 4px 20px ${profileData.profileColor}50`;
    }

    setAvatar(pfp, profileData.avatar, profileData.username);

    // Show/hide edit button
    const isOwn = currentUser && currentUser.discordId === profileData.discordId;
    editBtn.style.display = isOwn ? 'block' : 'none';

    renderContent();
  }catch(e){
    username.textContent = 'Error loading profile';
    console.error(e);
  }
}

/* SET AVATAR */
function setAvatar(el, url, name){
  el.innerHTML = '';
  if(url){
    const img = document.createElement('img');
    img.src = url;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    el.appendChild(img);
  }else{
    el.textContent = (name || 'U').charAt(0).toUpperCase();
    el.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
    el.style.display = 'flex';
    el.style.alignItems = 'center';
    el.style.justifyContent = 'center';
    el.style.color = 'white';
    el.style.fontWeight = '700';
  }
}

/* RENDER CONTENT */
function renderContent(){
  videosTab.innerHTML = "";
  shortsTab.innerHTML = "";

  if(!profileData || !profileData.videos) return;

  const videoList = profileData.videos.filter(v => v.format !== 'short');
  const shortList = profileData.videos.filter(v => v.format === 'short');

  videoList.forEach(v=>{
    const card = createCard(v);
    videosTab.appendChild(card);
  });

  shortList.forEach(v=>{
    const card = createCard(v);
    shortsTab.appendChild(card);
  });

  if(videoList.length === 0) videosTab.innerHTML = '<div class="empty-message"><p>No videos yet</p></div>';
  if(shortList.length === 0) shortsTab.innerHTML = '<div class="empty-message"><p>No shorts yet</p></div>';
}

function createCard(v){
  const card = document.createElement("div");
  card.className = "card";
  card.onclick = () => window.location.href = `/post/${v.id}`;
  card.innerHTML = `
    <div class="thumb">
      ${v.type === 'video' ? `<video src="${v.fileUrl || v.filename}"></video>` : `<img src="${v.fileUrl || v.filename}">`}
    </div>
    <div class="title">${escapeHtml(v.title || 'Untitled')}</div>
    <div class="meta">${v.likes || 0} likes ‚Ä¢ ${new Date(v.createdAt).toLocaleDateString()}</div>
  `;
  return card;
}

function escapeHtml(text){
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* TABS */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    videosTab.style.display = tab.dataset.tab==="videos"?"grid":"none";
    shortsTab.style.display = tab.dataset.tab==="shorts"?"grid":"none";
  };
});

/* EDIT BUTTON */
editBtn.onclick = () => {
  const form = document.getElementById('editForm');
  const isShowing = form.style.display !== 'none';
  form.style.display = isShowing ? 'none' : 'block';
  
  if(!isShowing && profileData){
    document.getElementById('nameInput').value = profileData.username || '';
    document.getElementById('bioInput').value = profileData.bio || '';
    document.getElementById('bannerInput').value = profileData.banner || '';
    document.getElementById('colorInput').value = profileData.profileColor || '#3ea6ff';
    updateColorPreview();
    form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
};

// Color picker preview
const colorInput = document.getElementById('colorInput');
const colorPreview = document.getElementById('colorPreview');

function updateColorPreview() {
  const color = colorInput.value;
  colorPreview.style.background = color;
  colorPreview.style.color = '#fff';
  colorPreview.textContent = color;
}
colorInput.addEventListener('input', updateColorPreview);

document.getElementById('cancelEdit').onclick = () => {
  document.getElementById('editForm').style.display = 'none';
};

document.getElementById('profileForm').onsubmit = async (e) => {
  e.preventDefault();
  const status = document.getElementById('saveStatus');
  status.textContent = 'Saving...';
  
  const formData = new FormData();
  const name = document.getElementById('nameInput').value.trim();
  const bio = document.getElementById('bioInput').value.trim();
  const banner = document.getElementById('bannerInput').value.trim();
  const profileColor = document.getElementById('colorInput').value;
  const avatar = document.getElementById('avatarInput').files[0];
  
  if(name && name !== profileData.username) formData.append('username', name);
  if(bio !== (profileData.bio || '')) formData.append('bio', bio);
  if(banner !== (profileData.banner || '')) formData.append('banner', banner);
  if(profileColor !== (profileData.profileColor || '#3ea6ff')) formData.append('profileColor', profileColor);
  if(avatar) formData.append('avatar', avatar);
  
  // Check if there are any changes
  let hasChanges = false;
  for (const pair of formData.entries()) {
    hasChanges = true;
    break;
  }
  
  if(!hasChanges){
    status.textContent = 'No changes to save';
    return;
  }
  
  try{
    const res = await fetch('/api/me/profile', {
      method: 'PATCH',
      body: formData
    });
    
    if(!res.ok) throw new Error('Failed to save');
    
    status.textContent = 'Saved!';
    setTimeout(() => {
      status.textContent = '';
      location.reload();
    }, 1000);
  }catch(err){
    status.textContent = 'Error: ' + err.message;
  }
};

/* TOP AVATAR CLICK */
topAvatar.onclick = () => {
  if(currentUser) window.location.href = '/profile.html?id=me';
  else window.location.href = '/api/auth/login';
};

/* INIT */
async function init(){
  await loadUser();
  await loadProfile();
}

init();
</script>

</body>
</html>
