<!doctype html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Profile ‚Äì BeardedVibes</title>
<link rel="stylesheet" href="/style.css">

<style>
/* Profile-specific styles */
.profile-header{
  background: var(--yt-bg-secondary, #181818);
  border-bottom: 1px solid var(--yt-border);
}

.profile-inner{
  max-width: 1200px;
  margin: auto;
  padding: 20px;
  display: flex;
  gap: 16px;
  align-items: center;
}

.profile-pfp{
  width: 96px;
  height: 96px;
  border-radius: 50%;
  overflow: hidden;
  background: linear-gradient(135deg, #667eea, #764ba2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 40px;
  font-weight: 700;
  flex-shrink: 0;
}

.profile-info{
  flex: 1;
}

.profile-info h1{
  margin: 0;
  font-size: 24px;
  color: var(--yt-text);
}

.handle{
  color: var(--yt-text-secondary);
  font-size: 14px;
  margin-top: 4px;
}

.stats{
  display: flex;
  gap: 16px;
  margin-top: 8px;
  font-size: 14px;
  color: var(--yt-text-secondary);
}

.stats b{
  color: var(--yt-text);
}

.btn{
  padding: 10px 16px;
  border: none;
  border-radius: 18px;
  background: var(--yt-accent);
  color: #000;
  font-weight: 600;
  cursor: pointer;
  font-size: 14px;
}

.btn:hover{
  background: #5db3ff;
}

/* Tabs */
.profile-tabs{
  display: flex;
  gap: 32px;
  padding: 0 20px;
  background: var(--yt-bg-secondary, #181818);
  border-bottom: 1px solid var(--yt-border);
}

.tab{
  padding: 14px 0;
  cursor: pointer;
  color: var(--yt-text-secondary);
  border-bottom: 3px solid transparent;
  font-weight: 500;
}

.tab.active{
  color: var(--yt-text);
  border-color: var(--yt-accent);
}

/* Content */
.profile-content{
  max-width: 1200px;
  margin: auto;
  padding: 20px;
}

.grid{
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 16px;
}

.card{
  cursor: pointer;
  transition: transform 0.2s;
}

.card:hover{
  transform: scale(1.02);
}

.thumb{
  width: 100%;
  aspect-ratio: 16/9;
  background: #000;
  border-radius: 12px;
  overflow: hidden;
}

.thumb img,
.thumb video{
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.card .title{
  margin: 8px 0 4px;
  font-size: 14px;
  font-weight: 500;
  color: var(--yt-text);
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

.card .meta{
  color: var(--yt-text-secondary);
  font-size: 12px;
}
</style>
</head>

<body class="youtube-layout">
<body class="youtube-layout">

<header class="topbar">
  <div class="topbar-left">
    <button id="menu-btn" class="icon-btn" aria-label="Menu">‚ò∞</button>
    <a class="logo" href="/">BeardedVibes</a>
  </div>
  <div class="topbar-right">
    <div class="user-menu">
      <div class="user-avatar" id="top-avatar"></div>
    </div>
  </div>
</header>

<aside class="sidebar" id="sidebar">
  <nav class="sidebar-nav">
    <a href="/" class="nav-item">
      <span class="nav-icon">üè†</span>
      <span class="nav-label">Home</span>
    </a>
    <a href="/shorts.html" class="nav-item">
      <span class="nav-icon">üì±</span>
      <span class="nav-label">Shorts</span>
    </a>
    <a href="#" class="nav-item">
      <span class="nav-icon">üî•</span>
      <span class="nav-label">Trending</span>
    </a>
    <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--yt-border);">
    <a href="#" class="nav-item">
      <span class="nav-icon">üïê</span>
      <span class="nav-label">History</span>
    </a>
    <a href="#" class="nav-item">
      <span class="nav-icon">‚è∞</span>
      <span class="nav-label">Watch Later</span>
    </a>
    <a href="#" class="nav-item">
      <span class="nav-icon">üëç</span>
      <span class="nav-label">Liked</span>
    </a>
    <hr style="margin: 15px 0; border: none; border-top: 1px solid var(--yt-border);">
    <a href="/admin.html" class="nav-item" id="admin-nav-item" style="display: none;">
      <span class="nav-icon">‚öôÔ∏è</span>
      <span class="nav-label">Admin</span>
    </a>
  </nav>
</aside>

<main class="content" style="padding: 0;">
<section class="profile-header">
  <div class="profile-inner">
    <div class="profile-pfp" id="pfp">U</div>

    <div class="profile-info">
      <h1 id="username">Loading‚Ä¶</h1>
      <div class="handle" id="handle">@user</div>
      <div class="stats">
        <div><b id="videos">0</b> videos</div>
        <div><b id="followers">0</b> subscribers</div>
        <div><b id="likes">0</b> likes</div>
      </div>
    </div>

    <button class="btn" id="editBtn">Edit profile</button>
  </div>
</section>

<nav class="profile-tabs">
  <div class="tab active" data-tab="videos">Videos</div>
  <div class="tab" data-tab="shorts">Shorts</div>
</nav>

<div class="profile-content">
  <!-- Edit Form (hidden by default) -->
  <div id="editForm" style="display:none; background:var(--yt-bg-secondary, #181818); border:1px solid var(--yt-border); border-radius:8px; padding:20px; margin-bottom:20px;">
    <h2 style="margin:0 0 16px; font-size:18px; color:var(--yt-text);">Edit Profile</h2>
    <form id="profileForm">
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-size:14px; color:var(--yt-text);">Display Name</label>
        <input id="nameInput" type="text" maxlength="80" style="width:100%; padding:10px; background:var(--yt-bg); border:1px solid var(--yt-border); border-radius:4px; color:var(--yt-text); font-size:14px;">
      </div>
      <div style="margin-bottom:16px;">
        <label style="display:block; margin-bottom:6px; font-size:14px; color:var(--yt-text);">Profile Picture</label>
        <input id="avatarInput" type="file" accept="image/*" style="display:block; padding:8px; background:var(--yt-bg); border:1px solid var(--yt-border); border-radius:4px; color:var(--yt-text); font-size:14px;">
      </div>
      <div style="display:flex; gap:12px; align-items:center;">
        <button type="submit" class="btn">Save Changes</button>
        <button type="button" id="cancelEdit" style="padding:10px 16px; border:1px solid var(--yt-border); border-radius:18px; background:transparent; color:var(--yt-text); cursor:pointer; font-size:14px;">Cancel</button>
        <span id="saveStatus" style="color:var(--yt-text-secondary); font-size:14px;"></span>
      </div>
    </form>
  </div>

  <div id="videosTab" class="grid"></div>
  <div id="shortsTab" class="grid" style="display:none"></div>
</div>
</main>

<script>
const sidebar = document.getElementById('sidebar');
const menuBtn = document.getElementById('menu-btn');
const topAvatar = document.getElementById('top-avatar');

menuBtn.addEventListener('click', () => {
  sidebar.classList.toggle('collapsed');
});

let currentUser = null;
let profileData = null;

/* LOAD CURRENT USER */
async function loadUser(){
  try{
    const res = await fetch('/api/auth/me');
    if(!res.ok) throw new Error('Not logged in');
    const data = await res.json();
    currentUser = data.user;
    setAvatar(topAvatar, currentUser.avatar, currentUser.username);
    
    if(currentUser?.isAdmin){
      document.getElementById('admin-nav-item').style.display = 'flex';
    }
    
    topAvatar.onclick = () => window.location.href = '/profile.html?id=me';
  }catch(e){
    topAvatar.textContent = 'U';
    topAvatar.onclick = () => window.location.href = '/api/auth/login';
  }
}

/* LOAD PROFILE */
async function loadProfile(){
  const params = new URLSearchParams(window.location.search);
  const id = params.get('id');
  const isSelf = !id || id === 'me';

  if(isSelf && !currentUser){
    username.textContent = 'Not logged in';
    handle.textContent = 'Please sign in';
    return;
  }

  const endpoint = isSelf ? '/api/me/profile' : `/api/user/${id}/profile`;

  try{
    const res = await fetch(endpoint);
    if(!res.ok) throw new Error('Profile not found');
    profileData = await res.json();
    
    username.textContent = profileData.username || 'User';
    handle.textContent = '@' + (profileData.discordId || 'user');
    videos.textContent = profileData.totalVideos || 0;
    followers.textContent = profileData.followerCount || 0;
    likes.textContent = profileData.totalLikes || 0;

    setAvatar(pfp, profileData.avatar, profileData.username);

    // Show/hide edit button
    const isOwn = currentUser && currentUser.discordId === profileData.discordId;
    editBtn.style.display = isOwn ? 'block' : 'none';

    // Add verified badge if verified
    if(profileData.isVerified){
      const badge = document.createElement('span');
      badge.style.cssText = 'background:#065fd4;color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;font-weight:700;margin-left:8px';
      badge.textContent = '‚úì VERIFIED';
      username.appendChild(badge);
    }

    renderContent();
  }catch(e){
    username.textContent = 'Error loading profile';
    console.error(e);
  }
}

/* SET AVATAR */
function setAvatar(el, url, name){
  el.innerHTML = '';
  if(url){
    const img = document.createElement('img');
    img.src = url;
    img.style.width = '100%';
    img.style.height = '100%';
    img.style.objectFit = 'cover';
    el.appendChild(img);
  }else{
    el.textContent = (name || 'U').charAt(0).toUpperCase();
    el.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
    el.style.display = 'flex';
    el.style.alignItems = 'center';
    el.style.justifyContent = 'center';
    el.style.color = 'white';
    el.style.fontWeight = '700';
  }
}

/* RENDER CONTENT */
function renderContent(){
  videosTab.innerHTML = "";
  shortsTab.innerHTML = "";

  if(!profileData || !profileData.videos) return;

  const videoList = profileData.videos.filter(v => v.format !== 'short');
  const shortList = profileData.videos.filter(v => v.format === 'short');

  videoList.forEach(v=>{
    const card = createCard(v);
    videosTab.appendChild(card);
  });

  shortList.forEach(v=>{
    const card = createCard(v);
    shortsTab.appendChild(card);
  });

  if(videoList.length === 0) videosTab.innerHTML = '<p style="color:var(--yt-text-secondary)">No videos yet</p>';
  if(shortList.length === 0) shortsTab.innerHTML = '<p style="color:var(--yt-text-secondary)">No shorts yet</p>';
}

function createCard(v){
  const card = document.createElement("div");
  card.className = "card";
  card.onclick = () => window.location.href = `/post/${v.id}`;
  card.innerHTML = `
    <div class="thumb">
      ${v.type === 'video' ? `<video src="${v.fileUrl || v.filename}"></video>` : `<img src="${v.fileUrl || v.filename}">`}
    </div>
    <div class="title">${escapeHtml(v.title || 'Untitled')}</div>
    <div class="meta">${v.likes || 0} likes ‚Ä¢ ${new Date(v.createdAt).toLocaleDateString()}</div>
  `;
  return card;
}

function escapeHtml(text){
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

/* TABS */
document.querySelectorAll(".tab").forEach(tab=>{
  tab.onclick = ()=>{
    document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
    tab.classList.add("active");
    videosTab.style.display = tab.dataset.tab==="videos"?"grid":"none";
    shortsTab.style.display = tab.dataset.tab==="shorts"?"grid":"none";
  };
});

/* EDIT BUTTON */
editBtn.onclick = () => {
  const form = document.getElementById('editForm');
  const isShowing = form.style.display !== 'none';
  form.style.display = isShowing ? 'none' : 'block';
  
  if(!isShowing && profileData){
    document.getElementById('nameInput').value = profileData.username || '';
    form.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
  }
};

document.getElementById('cancelEdit').onclick = () => {
  document.getElementById('editForm').style.display = 'none';
};

document.getElementById('profileForm').onsubmit = async (e) => {
  e.preventDefault();
  const status = document.getElementById('saveStatus');
  status.textContent = 'Saving...';
  
  const formData = new FormData();
  const name = document.getElementById('nameInput').value.trim();
  const avatar = document.getElementById('avatarInput').files[0];
  
  if(name && name !== profileData.username) formData.append('username', name);
  if(avatar) formData.append('avatar', avatar);
  
  if(!formData.has('username') && !formData.has('avatar')){
    status.textContent = 'No changes to save';
    return;
  }
  
  try{
    const res = await fetch('/api/me/profile', {
      method: 'PATCH',
      body: formData
    });
    
    if(!res.ok) throw new Error('Failed to save');
    
    status.textContent = 'Saved!';
    setTimeout(() => {
      status.textContent = '';
      location.reload();
    }, 1000);
  }catch(err){
    status.textContent = 'Error: ' + err.message;
  }
};

/* EDIT BUTTON */
editBtn.onclick = () => {
  window.location.href = '/profile-edit.html';
};

/* TOP AVATAR CLICK */
topAvatar.onclick = () => {
  if(currentUser) window.location.href = '/profile.html?id=me';
  else window.location.href = '/api/auth/login';
};

/* INIT */
async function init(){
  await loadUser();
  await loadProfile();
}

init();
</script>

</body>
</html>
